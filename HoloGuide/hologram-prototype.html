<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HoloGuide - التجربة التفاعلية</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #332e8b;
            --secondary: #a4c5cc;
            --accent: #792b97;
            --white: #ffffff;
            --light-bg: #f8faff;
            --text-dark: #1a1a2e;
            --text-light: #6b7280;
            --success: #10b981;
            --error: #ef4444;
            --hologram-blue: #00ffff;
            --hologram-pink: #ff00ff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #000;
            color: var(--white);
            overflow: hidden;
            height: 100vh;
        }

        /* Hologram Container */
        .hologram-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            background: radial-gradient(circle at center, #1a1a2e 0%, #000 70%);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        /* Hologram Effect Background */
        .hologram-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                linear-gradient(45deg, transparent 30%, rgba(0, 255, 255, 0.1) 50%, transparent 70%),
                linear-gradient(-45deg, transparent 30%, rgba(255, 0, 255, 0.1) 50%, transparent 70%);
            animation: hologramScan 3s linear infinite;
        }

        @keyframes hologramScan {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(100%); }
        }

        /* Hologram Character */
        .hologram-character {
            position: relative;
            width: 300px;
            height: 400px;
            z-index: 10;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .hologram-character:hover {
            transform: scale(1.05);
        }

        .hologram-character:hover .character-body {
            box-shadow: 
                0 0 40px var(--hologram-blue),
                0 0 80px var(--hologram-pink),
                inset 0 0 40px rgba(255, 255, 255, 0.5);
        }

        .character-body {
            width: 200px;
            height: 300px;
            background: linear-gradient(135deg, 
                rgba(0, 255, 255, 0.8) 0%, 
                rgba(255, 0, 255, 0.6) 50%, 
                rgba(0, 255, 255, 0.8) 100%);
            border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
            position: relative;
            margin: 0 auto;
            animation: hologramPulse 2s ease-in-out infinite;
            box-shadow: 
                0 0 20px var(--hologram-blue),
                0 0 40px var(--hologram-pink),
                inset 0 0 20px rgba(255, 255, 255, 0.3);
        }

        @keyframes hologramPulse {
            0%, 100% { 
                transform: scale(1); 
                opacity: 0.9;
                box-shadow: 
                    0 0 20px var(--hologram-blue),
                    0 0 40px var(--hologram-pink),
                    inset 0 0 20px rgba(255, 255, 255, 0.3);
            }
            50% { 
                transform: scale(1.05); 
                opacity: 1;
                box-shadow: 
                    0 0 30px var(--hologram-blue),
                    0 0 60px var(--hologram-pink),
                    inset 0 0 30px rgba(255, 255, 255, 0.5);
            }
        }

        .character-face {
            position: absolute;
            top: 20%;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 80px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: var(--primary);
            animation: hologramGlow 1.5s ease-in-out infinite alternate;
        }

        @keyframes hologramGlow {
            from { box-shadow: 0 0 10px var(--hologram-blue); }
            to { box-shadow: 0 0 20px var(--hologram-pink); }
        }

        .character-arms {
            position: absolute;
            top: 30%;
            width: 100%;
            height: 60px;
        }

        .arm {
            position: absolute;
            width: 20px;
            height: 60px;
            background: linear-gradient(135deg, 
                rgba(0, 255, 255, 0.8), 
                rgba(255, 0, 255, 0.6));
            border-radius: 10px;
            animation: armWave 2s ease-in-out infinite;
        }

        .arm-left {
            left: 20px;
            transform-origin: top;
            animation-delay: 0s;
        }

        .arm-right {
            right: 20px;
            transform-origin: top;
            animation-delay: 1s;
        }

        @keyframes armWave {
            0%, 100% { transform: rotate(0deg); }
            50% { transform: rotate(15deg); }
        }

        /* Speech Bubbles */
        .speech-bubble {
            position: absolute;
            background: rgba(0, 255, 255, 0.9);
            color: var(--text-dark);
            padding: 1rem 1.5rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 1.1rem;
            max-width: 300px;
            word-wrap: break-word;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
            animation: bubbleFloat 3s ease-in-out infinite;
        }

        .speech-bubble::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-top: 10px solid rgba(0, 255, 255, 0.9);
        }

        .speech-bubble.user {
            background: rgba(255, 0, 255, 0.9);
            top: 20%;
            right: 20%;
            box-shadow: 0 0 20px rgba(255, 0, 255, 0.5);
        }

        .speech-bubble.user::after {
            border-top-color: rgba(255, 0, 255, 0.9);
            right: 20px;
            left: auto;
        }

        .speech-bubble.ai {
            background: rgba(0, 255, 255, 0.9);
            top: 20%;
            left: 20%;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
        }

        @keyframes bubbleFloat {
            0%, 100% { transform: translateY(0px); opacity: 0.8; }
            50% { transform: translateY(-10px); opacity: 1; }
        }

        /* Input Interface */
        .input-interface {
            position: absolute;
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            max-width: 600px;
            z-index: 20;
        }

        .input-container {
            display: flex;
            gap: 1rem;
            align-items: center;
            background: rgba(0, 0, 0, 0.8);
            padding: 1rem;
            border-radius: 50px;
            border: 2px solid var(--hologram-blue);
            backdrop-filter: blur(10px);
        }

        .voice-input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--white);
            font-size: 1.1rem;
            padding: 0.5rem 1rem;
            outline: none;
        }

        .voice-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .voice-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, var(--hologram-blue), var(--hologram-pink));
            color: var(--white);
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .voice-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 0 20px var(--hologram-blue);
        }

        .voice-btn.recording {
            animation: recordingPulse 1s ease-in-out infinite;
        }

        @keyframes recordingPulse {
            0%, 100% { box-shadow: 0 0 20px var(--hologram-blue); }
            50% { box-shadow: 0 0 40px var(--hologram-pink); }
        }

        /* Quick Actions */
        .quick-actions {
            position: absolute;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            justify-content: center;
            z-index: 20;
        }

        .quick-btn {
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid var(--hologram-blue);
            color: var(--white);
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            backdrop-filter: blur(10px);
        }

        .quick-btn:hover {
            background: rgba(0, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        /* Status Indicator */
        .status-indicator {
            position: absolute;
            top: 120px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: var(--hologram-blue);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            backdrop-filter: blur(10px);
            border: 1px solid var(--hologram-blue);
            z-index: 20;
        }

        /* Side Panel Map Overlay */
        .map-overlay {
            position: absolute;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            width: 400px;
            height: 500px;
            background: rgba(0, 0, 0, 0.95);
            border: 3px solid var(--hologram-blue);
            border-radius: 20px;
            backdrop-filter: blur(15px);
            z-index: 25;
            display: none;
            box-shadow: 
                0 0 50px rgba(0, 255, 255, 0.3),
                inset 0 0 50px rgba(0, 255, 255, 0.1);
        }

        .map-overlay.show {
            display: block;
            animation: mapSlideInFromRight 0.6s ease-out;
        }

        .map-overlay.hover {
            display: block;
            animation: mapHoverInFromRight 0.4s ease-out;
        }

        @keyframes mapSlideInFromRight {
            from { 
                transform: translateY(-50%) translateX(100%); 
                opacity: 0; 
            }
            to { 
                transform: translateY(-50%) translateX(0); 
                opacity: 1; 
            }
        }

        @keyframes mapHoverInFromRight {
            from { 
                transform: translateY(-50%) translateX(50%); 
                opacity: 0; 
            }
            to { 
                transform: translateY(-50%) translateX(0); 
                opacity: 1; 
            }
        }

        .map-close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255, 0, 0, 0.8);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            z-index: 30;
            transition: all 0.3s ease;
        }

        .map-close-btn:hover {
            background: rgba(255, 0, 0, 1);
            transform: scale(1.1);
        }

        .map-content {
            padding: 1rem;
            height: 100%;
            overflow: auto;
            position: relative;
        }

        .map-title {
            color: var(--hologram-blue);
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            text-align: center;
            text-shadow: 0 0 10px var(--hologram-blue);
        }

        .blueprint-container {
            width: 100%;
            height: calc(100% - 60px);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .blueprint-svg {
            width: 100%;
            height: 100%;
            max-width: 350px;
            max-height: 400px;
        }

        .hologram-marker {
            fill: rgba(255, 0, 255, 0.9);
            stroke: #ff00ff;
            stroke-width: 3;
            filter: drop-shadow(0 0 10px #ff00ff);
        }

        .destination-marker {
            fill: rgba(0, 255, 255, 0.9);
            stroke: #00ffff;
            stroke-width: 3;
            filter: drop-shadow(0 0 10px #00ffff);
        }

        .navigation-path {
            stroke: #ffff00;
            stroke-width: 4;
            fill: none;
            filter: drop-shadow(0 0 5px #ffff00);
        }

        .path-arrow {
            fill: #ffff00;
            filter: drop-shadow(0 0 5px #ffff00);
        }

        /* Hologram Header */
        .hologram-header {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 20;
        }

        .hologram-logo {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(0, 0, 0, 0.8);
            padding: 0.5rem 1rem;
            border-radius: 25px;
            backdrop-filter: blur(10px);
            border: 2px solid var(--hologram-blue);
        }

        /* Back Button */
        .back-btn {
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid var(--hologram-blue);
            color: var(--white);
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            backdrop-filter: blur(10px);
        }

        .back-btn:hover {
            background: rgba(0, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0, 255, 255, 0.3);
            border-top: 3px solid var(--hologram-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .hologram-character {
                width: 250px;
                height: 350px;
            }

            .character-body {
                width: 150px;
                height: 250px;
            }

            .speech-bubble {
                max-width: 250px;
                font-size: 1rem;
            }

            .quick-actions {
                top: 30px;
            }

            .quick-btn {
                padding: 0.5rem 1rem;
                font-size: 0.8rem;
            }

            .input-interface {
                width: 90%;
            }

            /* Mobile map overlay adjustments */
            .map-overlay {
                width: 90vw;
                height: 60vh;
                right: 5vw;
                top: 20%;
                transform: translateY(0);
            }

            .blueprint-svg {
                max-width: 300px;
                max-height: 300px;
            }

            .map-title {
                font-size: 1rem;
            }
        }

        @media (max-width: 480px) {
            .map-overlay {
                width: 95vw;
                height: 50vh;
                right: 2.5vw;
                top: 25%;
            }

            .blueprint-svg {
                max-width: 250px;
                max-height: 250px;
            }

            .hologram-character {
                width: 200px;
                height: 300px;
            }

            .character-body {
                width: 120px;
                height: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="hologram-container">
        <!-- Hologram Background Effect -->
        <div class="hologram-bg"></div>

        <!-- Header with Logo -->
        <div class="hologram-header">
            <a href="main-website.html" class="back-btn">
                <i class="fas fa-arrow-right"></i> العودة للموقع الرئيسي
            </a>
            <div class="hologram-logo">
                <img src="HoloGuideLogo.jpg" alt="HoLoGuide Logo" style="width: 40px; height: 40px; border-radius: 8px;">
                <span style="color: var(--hologram-blue); font-size: 1.2rem; font-weight: bold; margin-right: 10px;">HoloGuide</span>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions">
            <button class="quick-btn" data-query="وين أقرب دورة مياه؟">
                <i class="fas fa-toilet"></i> دورة مياه
            </button>
            <button class="quick-btn" data-query="وين المطعم؟">
                <i class="fas fa-utensils"></i> مطعم
            </button>
            <button class="quick-btn" data-query="وين المسرح؟">
                <i class="fas fa-microphone"></i> مسرح
            </button>
            <button class="quick-btn" data-query="وين موقف السيارات؟">
                <i class="fas fa-parking"></i> موقف سيارات
            </button>
            <button class="quick-btn" data-query="مخارج الطوارئ">
                <i class="fas fa-exit"></i> طوارئ
            </button>
            <button class="quick-btn" data-query="أريد رؤية خريطة المبنى">
                <i class="fas fa-map"></i> خريطة
            </button>
        </div>

        <!-- Status Indicator -->
        <div class="status-indicator" id="statusIndicator">
            اضغط على المايك للتحدث
        </div>

        <!-- Hologram Character -->
        <div class="hologram-character">
            <div class="character-body">
                <div class="character-face">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="character-arms">
                    <div class="arm arm-left"></div>
                    <div class="arm arm-right"></div>
                </div>
            </div>
        </div>

        <!-- Speech Bubbles -->
        <div class="speech-bubble ai" id="aiBubble" style="display: none;">
            <div id="aiMessage">مرحباً! أنا مساعدك الهولوجرامي. كيف يمكنني مساعدتك؟</div>
        </div>

        <div class="speech-bubble user" id="userBubble" style="display: none;">
            <div id="userMessage"></div>
        </div>

        <!-- Enhanced Map Overlay -->
        <div class="map-overlay" id="mapOverlay">
            <button class="map-close-btn" id="mapCloseBtn">×</button>
            <div class="map-content">
                <h3 class="map-title" id="mapTitle">خريطة المبنى التفاعلية</h3>
                <div class="blueprint-container" id="blueprintContainer">
                    <div id="mapContent">
                        <p style="text-align: center; color: var(--hologram-blue); font-size: 1.2rem;">
                            اضغط على الهولوجرام أو اسأل عن مكان معين لرؤية الخريطة
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Input Interface -->
        <div class="input-interface">
            <div class="input-container">
                <input type="text" class="voice-input" id="voiceInput" placeholder="اسألني أي شيء عن المبنى..." autocomplete="off">
                <button class="voice-btn" id="voiceBtn">
                    <i class="fas fa-microphone"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        
 // Secure configuration - API keys are hidden on the server
const ELEVENLABS_CONFIG = {
    apiUrl: '/api/text-to-speech' // Calls your serverless function instead
};

        // Global variables
        let isRecording = false;
        let currentAudio = null;

        

        // DOM elements
        const voiceBtn = document.getElementById('voiceBtn');
        const voiceInput = document.getElementById('voiceInput');
        const statusIndicator = document.getElementById('statusIndicator');
        const aiBubble = document.getElementById('aiBubble');
        const userBubble = document.getElementById('userBubble');
        const aiMessage = document.getElementById('aiMessage');
        const userMessage = document.getElementById('userMessage');
        const mapOverlay = document.getElementById('mapOverlay');
        const mapCloseBtn = document.getElementById('mapCloseBtn');
        const mapTitle = document.getElementById('mapTitle');
        const blueprintContainer = document.getElementById('blueprintContainer');
        const hologramCharacter = document.querySelector('.hologram-character');

        // Event Management Knowledge Base - Arabic
        const eventKnowledge = {
            locations: {
                // Bathrooms/Toilets
                'دورة مياه': 'دورات المياه تقع في الجهة الشرقية من المبنى، بجانب المدخل الرئيسي. اتبع اللافتات الزرقاء',
                'حمام': 'الحمامات موجودة في كل طابق، الأقرب لك في نهاية الممر على اليمين',
                'تواليت': 'التواليت تجدها بعد المدخل الرئيسي مباشرة على اليسار، مسافة 30 متر',
                
                // Gates/Entrances
                'بوابة a': 'بوابة A تقع في الجهة الشمالية من المبنى، استخدم المدخل الرئيسي ثم اتجه شمالاً',
                'بوابة b': 'بوابة B في الجهة الجنوبية، اتبع اللافتات الخضراء من المدخل الرئيسي',
                'بوابة c': 'بوابة C في الطابق الثاني، استخدم الدرج أو المصعد من المدخل الرئيسي',
                'مدخل': 'المدخل الرئيسي أمامك مباشرة، اتبع الحشود',
                'باب': 'الأبواب الرئيسية تقع في مقدمة المبنى مع أمن واستقبال',
                
                // Theater/Auditorium
                'مسرح': 'المسرح الرئيسي في الطابق الأول، اتبع الممر الأزرق لمدة دقيقتين',
                'قاعة': 'القاعة الكبرى في الطابق الثاني، استخدم المصعد أو الدرج',
                'مدرج': 'المدرج يقع في الجهة الغربية، اتبع اللافتات البنفسجية',
                
                // Dining/Food
                'مطعم': 'منطقة المطاعم في الطابق الثاني، استخدم المصعد من المدخل الرئيسي',
                'كافيتيريا': 'الكافيتيريا في الطابق الأرضي، اتجه يساراً من المدخل الرئيسي',
                'طعام': 'منطقة الطعام والمشروبات في الجناح الشرقي، اتبع اللافتات الحمراء',
                'مقهى': 'المقهى موجود في البهو الرئيسي، بجانب منطقة الاستقبال',
                
                // Stairs/Elevators
                'درج': 'الدرج الرئيسي يقع في وسط المبنى، ستجده خلف منطقة الاستقبال',
                'مصعد': 'المصاعد تقع بجانب الدرج الرئيسي، في وسط المبنى',
                'سلم': 'السلم الطارئ في نهاية كل ممر، لكن الدرج الرئيسي أفضل',
                
                // Parking
                'موقف': 'موقف السيارات في الخارج، اتبع اللافتات الصفراء عند الخروج',
                'باركنج': 'الباركنج الرئيسي خلف المبنى، والباركنج الـ VIP في المقدمة',
                'سيارة': 'مواقف السيارات متوفرة في الطوابق تحت الأرض والخارج',
                
                // Registration/Information
                'استقبال': 'منطقة الاستقبال في البهو الرئيسي فور دخولك من المدخل',
                'تسجيل': 'كاونتر التسجيل بجانب الاستقبال، ستجد الموظفين هناك',
                'معلومات': 'مكتب المعلومات في وسط البهو، الموظفون هناك يساعدونك',
                
                // Exhibition areas
                'معرض': 'منطقة المعرض في الجناح الشرقي، اتبع اللافتات البرتقالية',
                'جناح': 'الأجنحة موزعة على طوابق متعددة، أي جناح تريد تحديداً؟',
                'صالة': 'الصالة الرئيسية في الطابق الأول، مساحة مفتوحة كبيرة',
                
                // Emergency
                'إسعافات': 'نقطة الإسعافات الأولية بجانب الاستقبال في الطابق الأرضي',
                'أمن': 'نقاط الأمن موزعة في كل طابق، الرئيسية عند المدخل',
                'طوارئ': 'مخارج الطوارئ مؤشرة باللافتات الحمراء في كل ممر'
            },
            
            generalDirections: {
                'فوق': 'للطابق العلوي، استخدم الدرج أو المصعد في وسط المبنى',
                'تحت': 'للطابق السفلي، استخدم نفس الدرج أو المصعد',
                'يمين': 'اتجه يميناً من موقعك الحالي',
                'يسار': 'اتجه يساراً من موقعك الحالي',
                'أمام': 'استمر في المشي للأمام في نفس الاتجاه',
                'خلف': 'ارجع للخلف أو اتجه للاتجاه المعاكس'
            }
        };

        // Initialize the system
        document.addEventListener('DOMContentLoaded', function() {
            loadVenueData();
            initializeVoiceSystem();
            setupEventListeners();
            showWelcomeMessage();
        });

        // Load venue data
        async function loadVenueData() {
            try {
                const response = await fetch('data/venue-data-arabic.json');
                window.venueData = await response.json();
            } catch (error) {
                console.error('Error loading venue data:', error);
            }
        }

        // Show welcome message
        function showWelcomeMessage() {
            setTimeout(() => {
                showAIMessage('مرحباً! أنا مساعدك الهولوجرامي الذكي. كيف يمكنني مساعدتك في التنقل داخل المبنى؟');
            }, 1000);
        }

        // Initialize voice recognition system
        function initializeVoiceSystem() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                updateStatus('المتصفح لا يدعم التعرف على الصوت. استخدم الكتابة', 'error');
                voiceBtn.disabled = true;
                voiceBtn.innerHTML = '❌';
                return;
            }
            
            updateStatus('اضغط على المايك للتحدث', 'success');
        }

        // Setup all event listeners
        function setupEventListeners() {
            // Voice button event
            voiceBtn.addEventListener('click', toggleRecording);
            
            // Voice input events
            voiceInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    handleTextInput();
                }
            });
            
            // Quick action buttons
            document.querySelectorAll('.quick-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    const query = e.currentTarget.getAttribute('data-query');
                    handleUserQuery(query);
                });
            });

            // Hologram character hover events
            hologramCharacter.addEventListener('mouseenter', function() {
                showMapOnHover();
            });

            hologramCharacter.addEventListener('mouseleave', function() {
                hideMapOnHover();
            });

            // Map close button
            mapCloseBtn.addEventListener('click', function() {
                hideMap();
            });

            // Click outside map to close
            mapOverlay.addEventListener('click', function(e) {
                if (e.target === mapOverlay) {
                    hideMap();
                }
            });

            // Escape key to close map
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && mapOverlay.classList.contains('show')) {
                    hideMap();
                }
            });
        }

        // Toggle voice recording
        function toggleRecording() {
            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        }

        // Start voice recording
        function startRecording() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = new SpeechRecognition();
            
            // Configure recognition for Saudi Arabic
            recognition.lang = 'ar-SA';
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;
            
            recognition.onstart = function() {
                isRecording = true;
                voiceBtn.classList.add('recording');
                voiceBtn.innerHTML = '<i class="fas fa-stop"></i>';
                updateStatus('جاري الاستماع... تحدث الآن', 'success');
            };
            
            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                voiceInput.value = transcript;
                updateStatus(`تم التعرف على: "${transcript}"`, 'success');
                handleUserQuery(transcript);
            };
            
            recognition.onerror = function(event) {
                updateStatus('خطأ في التعرف على الصوت. حاول مرة أخرى', 'error');
                resetRecordingState();
            };
            
            recognition.onend = function() {
                resetRecordingState();
            };
            
            try {
                recognition.start();
            } catch (error) {
                updateStatus('خطأ في بدء التسجيل', 'error');
                resetRecordingState();
            }
        }

        // Stop recording
        function stopRecording() {
            isRecording = false;
            resetRecordingState();
        }

        // Reset recording state
        function resetRecordingState() {
            isRecording = false;
            voiceBtn.classList.remove('recording');
            voiceBtn.innerHTML = '<i class="fas fa-microphone"></i>';
        }

        // Handle text input
        function handleTextInput() {
            const text = voiceInput.value.trim();
            if (text) {
                handleUserQuery(text);
                voiceInput.value = '';
            }
        }

        // Handle user query
        async function handleUserQuery(query) {
            showUserMessage(query);
            
            // Generate intelligent response
            const response = generateIntelligentResponse(query);
            
            // Show AI response
            setTimeout(() => {
                showAIMessage(response);
                
                // Play voice response
                playResponseWithElevenLabs(response);
            }, 1000);
        }

        // Generate intelligent response based on user query
        function generateIntelligentResponse(query) {
            const lowerQuery = query.toLowerCase();
            
            // Check for map request
            if (lowerQuery.includes('خريطة') || lowerQuery.includes('مخطط') || lowerQuery.includes('رسم')) {
                showMap();
                return 'إليك خريطة المبنى التفاعلية. يمكنك رؤية جميع الأماكن والمرافق';
            }
            
            // Check for specific locations and show navigation (updated coordinates for realistic layout)
            const locationMappings = {
                'دورة مياه': { response: 'دورات المياه تقع في الجناح الجنوبي الغربي، اتبع الممر الرئيسي ثم اتجه يساراً', coords: { x: 100, y: 380 } },
                'حمام': { response: 'الحمامات موجودة في الجناح الجنوبي الغربي، اتبع الممر الرئيسي', coords: { x: 100, y: 380 } },
                'تواليت': { response: 'التواليت في الجناح الجنوبي الغربي، اتبع الممر الرئيسي', coords: { x: 100, y: 380 } },
                'مطعم': { response: 'المطعم في الجناح الجنوبي الشرقي، اتبع الممر الرئيسي ثم اتجه يميناً', coords: { x: 300, y: 380 } },
                'طعام': { response: 'منطقة الطعام في الجناح الجنوبي الشرقي، اتبع الممر الرئيسي', coords: { x: 300, y: 380 } },
                'مسرح': { response: 'المسرح في الجناح الشمالي الغربي، اتبع الممر الرئيسي ثم اتجه يساراً', coords: { x: 100, y: 120 } },
                'قاعة': { response: 'القاعة الكبرى في الجناح الشمالي الشرقي، اتبع الممر الرئيسي ثم اتجه يميناً', coords: { x: 300, y: 120 } },
                'موقف': { response: 'موقف السيارات في الخارج، اتبع اللافتات الصفراء عند الخروج', coords: { x: 190, y: 30 } },
                'باركنج': { response: 'الباركنج الرئيسي خلف المبنى، والباركنج الـ VIP في المقدمة', coords: { x: 190, y: 30 } },
                'طوارئ': { response: 'مخارج الطوارئ في الجناح الجنوبي، اتبع اللافتات الحمراء', coords: { x: 190, y: 450 } },
                'مخرج': { response: 'المخارج الرئيسية في الجناح الجنوبي', coords: { x: 190, y: 450 } },
                'معلومات': { response: 'مكتب المعلومات في وسط البهو، الموظفون هناك يساعدونك', coords: { x: 200, y: 250 } },
                'استقبال': { response: 'منطقة الاستقبال في البهو الرئيسي فور دخولك من المدخل', coords: { x: 200, y: 250 } },
                'معرض': { response: 'منطقة المعرض في الجناح الشرقي، اتبع الممر الرئيسي ثم اتجه يميناً', coords: { x: 300, y: 260 } },
                'جناح': { response: 'الأجنحة موزعة في المبنى، أي جناح تريد تحديداً؟', coords: { x: 300, y: 260 } }
            };
            
            for (const [location, data] of Object.entries(locationMappings)) {
                if (lowerQuery.includes(location)) {
                    // Show navigation path
                    setTimeout(() => {
                        showNavigationPath(data.coords);
                    }, 2000);
                    return data.response;
                }
            }
            
            // Check for general directions
            for (const [direction, response] of Object.entries(eventKnowledge.generalDirections)) {
                if (lowerQuery.includes(direction)) {
                    return response;
                }
            }
            
            // Handle common question patterns
            if (lowerQuery.includes('وين') || lowerQuery.includes('أين') || lowerQuery.includes('كيف أروح')) {
                return 'يرجى تحديد المكان الذي تريد الذهاب إليه، مثل: المسرح، دورة المياه، المطعم، أو أي بوابة';
            }
            
            if (lowerQuery.includes('ساعة') || lowerQuery.includes('وقت')) {
                const now = new Date();
                const timeStr = now.toLocaleTimeString('ar-SA', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    hour12: true 
                });
                return `الوقت الحالي هو ${timeStr}`;
            }
            
            if (lowerQuery.includes('شكرا') || lowerQuery.includes('شكراً')) {
                return 'العفو! أي خدمة أخرى، أنا هنا لمساعدتك';
            }
            
            if (lowerQuery.includes('معلومات') || lowerQuery.includes('تفاصيل')) {
                if (window.venueData) {
                    const info = window.venueData.venue.venue_info;
                    return `معلومات المبنى: ساعات العمل ${info.hours}، السعة ${info.capacity}، ${info.floors}، ${info.accessibility}`;
                }
                return 'معلومات المبنى: مركز المؤتمرات والمعارض، مفتوح من 8 صباحاً إلى 10 مساءً';
            }
            
            // Default helpful response
            return 'يمكنني مساعدتك في العثور على: دورات المياه، المطاعم، المسرح، البوابات، مواقف السيارات، أو أي مكان آخر في المبنى. ما الذي تبحث عنه تحديداً؟';
        }

        // Show map on hover
        function showMapOnHover() {
            mapOverlay.classList.add('hover');
            mapTitle.textContent = 'خريطة المبنى التفاعلية - مرر الماوس لرؤية التفاصيل';
            showBasicMap();
        }

        // Hide map on hover end
        function hideMapOnHover() {
            setTimeout(() => {
                if (mapOverlay.classList.contains('hover')) {
                    mapOverlay.classList.remove('hover');
                }
            }, 2000);
        }

        // Show basic map with realistic building layout
        function showBasicMap() {
            const mapContent = document.getElementById('mapContent');
            mapContent.innerHTML = `
                <svg class="blueprint-svg" viewBox="0 0 400 500">
                    <!-- Building exterior walls -->
                    <rect x="20" y="20" width="360" height="460" fill="none" stroke="rgba(0,255,255,0.4)" stroke-width="3"/>
                    
                    <!-- Main corridor (vertical) -->
                    <rect x="180" y="40" width="40" height="420" fill="rgba(0,255,255,0.05)" stroke="rgba(0,255,255,0.3)" stroke-width="1"/>
                    
                    <!-- Horizontal corridors -->
                    <rect x="40" y="200" width="120" height="20" fill="rgba(0,255,255,0.05)" stroke="rgba(0,255,255,0.3)" stroke-width="1"/>
                    <rect x="240" y="200" width="120" height="20" fill="rgba(0,255,255,0.05)" stroke="rgba(0,255,255,0.3)" stroke-width="1"/>
                    <rect x="40" y="300" width="120" height="20" fill="rgba(0,255,255,0.05)" stroke="rgba(0,255,255,0.3)" stroke-width="1"/>
                    <rect x="240" y="300" width="120" height="20" fill="rgba(0,255,255,0.05)" stroke="rgba(0,255,255,0.3)" stroke-width="1"/>
                    
                    <!-- Theater (North West) -->
                    <rect x="40" y="60" width="120" height="120" fill="rgba(0,255,255,0.1)" stroke="rgba(0,255,255,0.5)" stroke-width="1"/>
                    <text x="100" y="120" text-anchor="middle" fill="rgba(0,255,255,0.8)" font-size="10">المسرح</text>
                    
                    <!-- Main Hall (North East) -->
                    <rect x="240" y="60" width="120" height="120" fill="rgba(0,255,255,0.1)" stroke="rgba(0,255,255,0.5)" stroke-width="1"/>
                    <text x="300" y="120" text-anchor="middle" fill="rgba(0,255,255,0.8)" font-size="10">القاعة الرئيسية</text>
                    
                    <!-- Exhibition (East) -->
                    <rect x="240" y="240" width="120" height="40" fill="rgba(0,255,255,0.1)" stroke="rgba(0,255,255,0.5)" stroke-width="1"/>
                    <text x="300" y="260" text-anchor="middle" fill="rgba(0,255,255,0.8)" font-size="10">المعرض</text>
                    
                    <!-- Restaurant (South East) -->
                    <rect x="240" y="340" width="120" height="80" fill="rgba(0,255,255,0.1)" stroke="rgba(0,255,255,0.5)" stroke-width="1"/>
                    <text x="300" y="380" text-anchor="middle" fill="rgba(0,255,255,0.8)" font-size="10">المطعم</text>
                    
                    <!-- Restrooms (South West) -->
                    <rect x="40" y="340" width="120" height="80" fill="rgba(0,255,255,0.1)" stroke="rgba(0,255,255,0.5)" stroke-width="1"/>
                    <text x="100" y="380" text-anchor="middle" fill="rgba(0,255,255,0.8)" font-size="10">دورات المياه</text>
                    
                    <!-- Emergency Exit (South) -->
                    <rect x="160" y="440" width="60" height="20" fill="rgba(255,0,0,0.3)" stroke="rgba(255,0,0,0.8)" stroke-width="2"/>
                    <text x="190" y="455" text-anchor="middle" fill="rgba(255,0,0,0.8)" font-size="8">مخرج الطوارئ</text>
                    
                    <!-- Main Entrance (North) -->
                    <rect x="160" y="20" width="60" height="20" fill="rgba(0,255,0,0.3)" stroke="rgba(0,255,0,0.8)" stroke-width="2"/>
                    <text x="190" y="35" text-anchor="middle" fill="rgba(0,255,0,0.8)" font-size="8">المدخل الرئيسي</text>
                    
                    <!-- Hologram location (center corridor) -->
                    <circle cx="200" cy="250" r="12" class="hologram-marker">
                        <animate attributeName="r" values="12;15;12" dur="1s" repeatCount="indefinite"/>
                    </circle>
                    <text x="200" y="255" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#ff00ff" font-weight="bold">أنت هنا</text>
                    
                    <!-- Scale indicator -->
                    <text x="20" y="490" fill="rgba(0,255,255,0.6)" font-size="8">مقياس: 1:100</text>
                </svg>
            `;
        }

        // Show map
        function showMap() {
            mapOverlay.classList.add('show');
            mapTitle.textContent = 'خريطة المبنى التفاعلية';
            showBasicMap();
        }

        // Hide map
        function hideMap() {
            mapOverlay.classList.remove('show', 'hover');
        }

        // Show navigation path with realistic building layout
        function showNavigationPath(destination) {
            mapOverlay.classList.add('show');
            mapTitle.textContent = 'مسار التنقل إلى الوجهة المطلوبة';
            const mapContent = document.getElementById('mapContent');
            
            // Create realistic SVG with proper wall boundaries
            const svg = `
                <svg class="blueprint-svg" viewBox="0 0 400 500">
                    <!-- Building exterior walls -->
                    <rect x="20" y="20" width="360" height="460" fill="none" stroke="rgba(0,255,255,0.4)" stroke-width="3"/>
                    
                    <!-- Main corridor (vertical) -->
                    <rect x="180" y="40" width="40" height="420" fill="rgba(0,255,255,0.05)" stroke="rgba(0,255,255,0.3)" stroke-width="1"/>
                    
                    <!-- Horizontal corridors -->
                    <rect x="40" y="200" width="120" height="20" fill="rgba(0,255,255,0.05)" stroke="rgba(0,255,255,0.3)" stroke-width="1"/>
                    <rect x="240" y="200" width="120" height="20" fill="rgba(0,255,255,0.05)" stroke="rgba(0,255,255,0.3)" stroke-width="1"/>
                    <rect x="40" y="300" width="120" height="20" fill="rgba(0,255,255,0.05)" stroke="rgba(0,255,255,0.3)" stroke-width="1"/>
                    <rect x="240" y="300" width="120" height="20" fill="rgba(0,255,255,0.05)" stroke="rgba(0,255,255,0.3)" stroke-width="1"/>
                    
                    <!-- Theater (North West) -->
                    <rect x="40" y="60" width="120" height="120" fill="rgba(0,255,255,0.1)" stroke="rgba(0,255,255,0.5)" stroke-width="1"/>
                    <text x="100" y="120" text-anchor="middle" fill="rgba(0,255,255,0.8)" font-size="10">المسرح</text>
                    
                    <!-- Main Hall (North East) -->
                    <rect x="240" y="60" width="120" height="120" fill="rgba(0,255,255,0.1)" stroke="rgba(0,255,255,0.5)" stroke-width="1"/>
                    <text x="300" y="120" text-anchor="middle" fill="rgba(0,255,255,0.8)" font-size="10">القاعة الرئيسية</text>
                    
                    <!-- Exhibition (East) -->
                    <rect x="240" y="240" width="120" height="40" fill="rgba(0,255,255,0.1)" stroke="rgba(0,255,255,0.5)" stroke-width="1"/>
                    <text x="300" y="260" text-anchor="middle" fill="rgba(0,255,255,0.8)" font-size="10">المعرض</text>
                    
                    <!-- Restaurant (South East) -->
                    <rect x="240" y="340" width="120" height="80" fill="rgba(0,255,255,0.1)" stroke="rgba(0,255,255,0.5)" stroke-width="1"/>
                    <text x="300" y="380" text-anchor="middle" fill="rgba(0,255,255,0.8)" font-size="10">المطعم</text>
                    
                    <!-- Restrooms (South West) -->
                    <rect x="40" y="340" width="120" height="80" fill="rgba(0,255,255,0.1)" stroke="rgba(0,255,255,0.5)" stroke-width="1"/>
                    <text x="100" y="380" text-anchor="middle" fill="rgba(0,255,255,0.8)" font-size="10">دورات المياه</text>
                    
                    <!-- Emergency Exit (South) -->
                    <rect x="160" y="440" width="60" height="20" fill="rgba(255,0,0,0.3)" stroke="rgba(255,0,0,0.8)" stroke-width="2"/>
                    <text x="190" y="455" text-anchor="middle" fill="rgba(255,0,0,0.8)" font-size="8">مخرج الطوارئ</text>
                    
                    <!-- Main Entrance (North) -->
                    <rect x="160" y="20" width="60" height="20" fill="rgba(0,255,0,0.3)" stroke="rgba(0,255,0,0.8)" stroke-width="2"/>
                    <text x="190" y="35" text-anchor="middle" fill="rgba(0,255,0,0.8)" font-size="8">المدخل الرئيسي</text>
                    
                    <!-- Hologram location (center corridor) -->
                    <circle cx="200" cy="250" r="12" class="hologram-marker">
                        <animate attributeName="r" values="12;15;12" dur="1s" repeatCount="indefinite"/>
                    </circle>
                    <text x="200" y="255" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#ff00ff" font-weight="bold">أنت هنا</text>
                    
                    <!-- Destination marker -->
                    <circle cx="${destination.x}" cy="${destination.y}" r="10" class="destination-marker">
                        <animate attributeName="r" values="10;12;10" dur="1s" repeatCount="indefinite"/>
                    </circle>
                    <text x="${destination.x}" y="${destination.y + 3}" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#00ffff" font-weight="bold">الوجهة</text>
                    
                    <!-- Navigation path with realistic routing -->
                    <defs>
                        <marker id="arrowhead" markerWidth="10" markerHeight="6" refX="9" refY="3" orient="auto">
                            <polygon points="0 0, 10 3, 0 6" fill="#ffff00" class="path-arrow"/>
                        </marker>
                    </defs>
                    <path d="M 200,250 L ${destination.x},${destination.y}" 
                          class="navigation-path" marker-end="url(#arrowhead)" stroke-dasharray="4,2">
                        <animate attributeName="stroke-dashoffset" values="0;6;0" dur="1.5s" repeatCount="indefinite"/>
                    </path>
                    
                    <!-- Distance indicator -->
                    <text x="${(200 + destination.x) / 2}" y="${(250 + destination.y) / 2 - 15}" text-anchor="middle" fill="#ffff00" font-size="8" font-weight="bold">
                        اتبع المسار الأصفر
                    </text>
                    
                    <!-- Scale indicator -->
                    <text x="20" y="490" fill="rgba(0,255,255,0.6)" font-size="8">مقياس: 1:100</text>
                </svg>
            `;
            
            mapContent.innerHTML = svg;
            
            // Auto-hide after 15 seconds
            setTimeout(() => {
                if (mapOverlay.classList.contains('show')) {
                    mapOverlay.classList.remove('show');
                }
            }, 15000);
        }

        // Show user message
        function showUserMessage(message) {
            userMessage.textContent = message;
            userBubble.style.display = 'block';
            
            setTimeout(() => {
                userBubble.style.display = 'none';
            }, 5000);
        }

        // Show AI message
        function showAIMessage(message) {
            aiMessage.textContent = message;
            aiBubble.style.display = 'block';
            
            setTimeout(() => {
                aiBubble.style.display = 'none';
            }, 8000);
        }

       // Play response using ElevenLabs API via serverless function
async function playResponseWithElevenLabs(text) {
    try {
        updateStatus('جاري تحضير الإجابة...', '');
        
        // Call YOUR serverless function instead of ElevenLabs directly
        const response = await fetch(ELEVENLABS_CONFIG.apiUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                text: text
            })
        });
        
        if (!response.ok) {
            throw new Error(`API error: ${response.status}`);
        }
        
        const audioBlob = await response.blob();
        const audioUrl = URL.createObjectURL(audioBlob);
        
        currentAudio = new Audio(audioUrl);
        
        currentAudio.onplay = () => {
            updateStatus('يتم تشغيل الإجابة بصوت سعودي', 'success');
        };
        
        currentAudio.onended = () => {
            updateStatus('انتهى التشغيل. اضغط المايك لسؤال آخر', 'success');
            URL.revokeObjectURL(audioUrl);
        };
        
        currentAudio.onerror = () => {
            updateStatus('خطأ في تشغيل الصوت', 'error');
            URL.revokeObjectURL(audioUrl);
        };
        
        await currentAudio.play();
        
    } catch (error) {
        console.warn('API failed, using browser TTS:', error);
        playResponseWithBrowserTTS(text);
    }
}

        // Fallback: Play response using browser TTS
        function playResponseWithBrowserTTS(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'ar-SA';
                utterance.rate = 0.9;
                utterance.pitch = 1;
                
                utterance.onstart = () => {
                    updateStatus('يتم تشغيل الإجابة (متصفح)', 'success');
                };
                
                utterance.onend = () => {
                    updateStatus('انتهى التشغيل. اضغط المايك لسؤال آخر', 'success');
                };
                
                utterance.onerror = () => {
                    updateStatus('خطأ في تشغيل الصوت', 'error');
                };
                
                speechSynthesis.speak(utterance);
            } else {
                updateStatus('المتصفح لا يدعم تحويل النص إلى كلام', 'error');
            }
        }

        // Update status message
        function updateStatus(message, type = '') {
            statusIndicator.textContent = message;
            statusIndicator.className = 'status-indicator';
            if (type) {
                statusIndicator.classList.add(type);
            }
        }
    </script>
</body>
</html>


